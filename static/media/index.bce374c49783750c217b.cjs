const fs=require("fs"),{exec:exec}=require("child_process"),express=require("express"),app=express();app.use(express.json());const FIRMWARE_DIR="/var/www/ar3s/firmware/avr/",SKETCH_DIR="/tmp/test-sketch/",SKETCH_FILE="sketch.ino";app.post("/api/build/avr",(e,r)=>{const{code:s,fqbn:i}=e.body;fs.existsSync(SKETCH_DIR)||fs.mkdirSync(SKETCH_DIR,{recursive:!0}),fs.existsSync(FIRMWARE_DIR)||fs.mkdirSync(FIRMWARE_DIR,{recursive:!0});const t=`${SKETCH_DIR}${SKETCH_FILE}`;fs.writeFileSync(t,s);exec(`docker run --rm     -v ${SKETCH_DIR}:/work/sketch     -v ${FIRMWARE_DIR}:/work/build     arduino-cli-avr     compile --fqbn ${i} --output-dir /work/build --warnings all /work/sketch/sketch.ino`,(e,s,i)=>{if(e)return console.error("Build failed:",i),r.status(500).json({error:"Compilation failed",details:i});const t=fs.readdirSync(FIRMWARE_DIR).filter(e=>e.endsWith(".hex")).map(e=>({fileName:e,fullPath:`${FIRMWARE_DIR}${e}`,updateTime:fs.statSync(`${FIRMWARE_DIR}${e}`).mtimeMs})).sort((e,r)=>r.updateTime-e.updateTime),o=t.length>0?t[0].fileName:null;return o?r.json({artifactUrl:`/firmware/avr/${o}`,log:s}):r.status(500).json({error:"No HEX file produced"})})});const port=process.env.PORT||8081;app.listen(port,()=>{console.log(`Ar3s AVR build API listening on port ${port}`)});